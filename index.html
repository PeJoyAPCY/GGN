<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GGN PATROL SYSTEM - ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    max-width: 480px;
    margin: auto;
    padding: 15px;
    background: #f0f0f5;
  }
  h2 {
    text-align: center;
    margin-bottom: 10px;
  }
  .box {
    background: white;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
  }
  select, input[type="file"], textarea, button {
    width: 100%;
    margin-bottom: 10px;
    font-size: 16px;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  .previewContainer img {
    width: 120px;
    height: 160px;
    object-fit: cover;
    border: 2px solid #444;
    border-radius: 6px;
    margin: 5px;
  }
  button {
    background-color: #004080;
    color: white;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0066cc;
  }
  .previewText {
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    white-space: pre-wrap;
    font-size: 15px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<h2>üì∑ GGN PATROL SYSTEM</h2>

<div class="box">
  <h3>‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</h3>
  <select id="zonePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <select id="jobTypePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
    <option value="‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à">‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</option>
    <option value="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
  </select>
  <input type="file" id="imageInputPatrol" accept="image/*" capture="environment" />
  <textarea id="textPatrol" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextPatrol"></div>
  <button onclick="sendPatrol()">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log</button>
  <div class="previewContainer" id="previewContainerPatrol"></div>
  <div id="statusPatrol"></div>
</div>

<div class="box">
  <h3>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏≠‡∏≠‡∏Å</h3>
  <select id="zoneSigninout">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <select id="jobTypeSigninout">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Checkin/Checkout --</option>
    <option value="Checkin">Checkin</option>
    <option value="Checkout">Checkout</option>
  </select>
  <input type="file" id="imageInputSigninout" accept="image/*" capture="environment" />
  <textarea id="textSigninout" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextSigninout"></div>
  <button onclick="sendSigninout()">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log</button>
  <div class="previewContainer" id="previewContainerSigninout"></div>
  <div id="statusSigninout"></div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const botToken = "7764756651:AAF4G_IFWjNzKoTJj_lpQW3oLANKAZIVnWU";
const chatId = "-7906742430";

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// ---- Patrol ----
const zonePatrol = document.getElementById("zonePatrol");
const jobTypePatrol = document.getElementById("jobTypePatrol");
const imageInputPatrol = document.getElementById("imageInputPatrol");
const previewContainerPatrol = document.getElementById("previewContainerPatrol");
const previewTextPatrol = document.getElementById("previewTextPatrol");
const extraTextPatrol = document.getElementById("textPatrol");
const statusPatrol = document.getElementById("statusPatrol");
let photoPatrol = null, locationPatrol = "";

imageInputPatrol.addEventListener("change", e => {
  photoPatrol = e.target.files[0];
  previewContainerPatrol.innerHTML = "";
  if(photoPatrol) {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(photoPatrol);
    previewContainerPatrol.appendChild(img);
  }
  updatePreviewTextPatrol();
});
zonePatrol.addEventListener("change", updatePreviewTextPatrol);
jobTypePatrol.addEventListener("change", updatePreviewTextPatrol);
extraTextPatrol.addEventListener("input", updatePreviewTextPatrol);

async function updatePreviewTextPatrol() {
  await getLocationPatrol();
  previewTextPatrol.textContent = 
    `üìÖ ${new Date().toLocaleString("th-TH")}
üìç ${locationPatrol}
üóÇ ‡πÄ‡∏Ç‡∏ï: ${zonePatrol.value || "-"}
üìå ‡∏á‡∏≤‡∏ô: ${jobTypePatrol.value || "-"}
${extraTextPatrol.value.trim() ? "üìù " + extraTextPatrol.value.trim() : ""}`;
}

function getLocationPatrol() {
  return new Promise(resolve => {
    if (!navigator.geolocation) return resolve("");
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=th`);
        const data = await res.json();
        locationPatrol = data.display_name || `${lat.toFixed(6)},${lon.toFixed(6)}`;
      } catch {
        locationPatrol = `${lat.toFixed(6)},${lon.toFixed(6)}`;
      }
      resolve();
    }, () => resolve());
  });
}

async function sendPatrol() {
  if (!photoPatrol) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û");
  if (!zonePatrol.value || !jobTypePatrol.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô");
  statusPatrol.textContent = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
  await updatePreviewTextPatrol();
  const caption = previewTextPatrol.textContent;
  await sendToTelegram(photoPatrol, caption, "patrol_log.xlsx", [
    ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏Ç‡∏ï", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"],
    [1, new Date().toLocaleString("th-TH"), locationPatrol, zonePatrol.value, jobTypePatrol.value, extraTextPatrol.value.trim()]
  ]);
  statusPatrol.textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
  resetPatrol();
}

function resetPatrol() {
  photoPatrol = null;
  previewContainerPatrol.innerHTML = "";
  previewTextPatrol.textContent = "";
  zonePatrol.value = "";
  jobTypePatrol.value = "";
  extraTextPatrol.value = "";
}

// ---- Signinout ----
const zoneSigninout = document.getElementById("zoneSigninout");
const jobTypeSigninout = document.getElementById("jobTypeSigninout");
const imageInputSigninout = document.getElementById("imageInputSigninout");
const previewContainerSigninout = document.getElementById("previewContainerSigninout");
const previewTextSigninout = document.getElementById("previewTextSigninout");
const extraTextSigninout = document.getElementById("textSigninout");
const statusSigninout = document.getElementById("statusSigninout");
let photoSigninout = null, locationSigninout = "";

imageInputSigninout.addEventListener("change", e => {
  photoSigninout = e.target.files[0];
  previewContainerSigninout.innerHTML = "";
  if(photoSigninout) {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(photoSigninout);
    previewContainerSigninout.appendChild(img);
  }
  updatePreviewTextSigninout();
});
zoneSigninout.addEventListener("change", updatePreviewTextSigninout);
jobTypeSigninout.addEventListener("change", updatePreviewTextSigninout);
extraTextSigninout.addEventListener("input", updatePreviewTextSigninout);

async function updatePreviewTextSigninout() {
  await getLocationSigninout();
  previewTextSigninout.textContent = 
    `üìÖ ${new Date().toLocaleString("th-TH")}
üìç ${locationSigninout}
üóÇ ‡πÄ‡∏Ç‡∏ï: ${zoneSigninout.value || "-"}
üìå ‡∏á‡∏≤‡∏ô: ${jobTypeSigninout.value || "-"}
${extraTextSigninout.value.trim() ? "üìù " + extraTextSigninout.value.trim() : ""}`;
}

function getLocationSigninout() {
  return new Promise(resolve => {
    if (!navigator.geolocation) return resolve("");
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=th`);
        const data = await res.json();
        locationSigninout = data.display_name || `${lat.toFixed(6)},${lon.toFixed(6)}`;
      } catch {
        locationSigninout = `${lat.toFixed(6)},${lon.toFixed(6)}`;
      }
      resolve();
    }, () => resolve());
  });
}

async function sendSigninout() {
  if (!photoSigninout) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û");
  if (!zoneSigninout.value || !jobTypeSigninout.value) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô");
  statusSigninout.textContent = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
  await updatePreviewTextSigninout();
  const caption = previewTextSigninout.textContent;
  await sendToTelegram(photoSigninout, caption, "signinout_log.xlsx", [
    ["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏Ç‡∏ï", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"],
    [1, new Date().toLocaleString("th-TH"), locationSigninout, zoneSigninout.value, jobTypeSigninout.value, extraTextSigninout.value.trim()]
  ]);
  statusSigninout.textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
  resetSigninout();
}

function resetSigninout() {
  photoSigninout = null;
  previewContainerSigninout.innerHTML = "";
  previewTextSigninout.textContent = "";
  zoneSigninout.value = "";
  jobTypeSigninout.value = "";
  extraTextSigninout.value = "";
}

// sendToTelegram helper
async function sendToTelegram(photo, caption, filename, logData) {
  const blob = await processImage(photo);
  const form = new FormData();
  form.append("chat_id", chatId);
  form.append("photo", blob, "photo.jpg");
  form.append("caption", caption);
  await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {method:"POST", body:form});

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(logData);
  XLSX.utils.book_append_sheet(wb, ws, "Log");
  const wbout = XLSX.write(wb, {bookType:"xlsx", type:"array"});
  const excelBlob = new Blob([wbout], {type:"application/octet-stream"});

  const logForm = new FormData();
  logForm.append("chat_id", chatId);
  logForm.append("document", excelBlob, filename);
  await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {method:"POST", body:logForm});
}

async function processImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.9);
    };
    img.src = URL.createObjectURL(file);
  });
}
</script>
</body>
</html>
