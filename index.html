<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GGN PATROL SYSTEM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    max-width: 480px;
    margin: auto;
    padding: 15px;
    background: #f0f0f5;
  }
  h2 {
    text-align: center;
    margin-bottom: 10px;
  }
  .box {
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }
  select, input[type="file"], textarea, button {
    width: 100%;
    margin-bottom: 10px;
    font-size: 16px;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  #previewContainerPatrol, #previewContainerSigninout {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-bottom: 10px;
  }
  #previewContainerPatrol img, #previewContainerSigninout img {
    width: 120px;
    height: 160px;
    object-fit: cover;
    border: 2px solid #444;
    border-radius: 6px;
  }
  button {
    background-color: #004080;
    color: white;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0066cc;
  }
  .previewText {
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    white-space: pre-wrap;
    font-size: 15px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<h2>üì∑ GGN PATROL SYSTEM</h2>

<div class="box">
  <h3>üöß ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</h3>
  <select id="zonePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <select id="jobTypePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
    <option value="‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à">‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</option>
    <option value="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
  </select>
  <input type="file" accept="image/*" capture="environment" id="imageInputPatrol" multiple>
  <textarea id="textPatrol" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextPatrol"></div>
  <button onclick="sendPatrol()">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log ‡πÄ‡∏Ç‡πâ‡∏≤ Telegram</button>
  <div id="previewContainerPatrol"></div>
  <div id="statusPatrol"></div>
</div>

<div class="box">
  <h3>üìù ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏≠‡∏≠‡∏Å</h3>
  <select id="zoneSigninout">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <label><input type="radio" name="inout" value="Checkin"> Checkin</label>
  <label><input type="radio" name="inout" value="Checkout"> Checkout</label>
  <input type="file" accept="image/*" capture="environment" id="imageInputSigninout" multiple>
  <textarea id="textSigninout" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextSigninout"></div>
  <button onclick="sendSigninout()">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log ‡πÄ‡∏Ç‡πâ‡∏≤ Telegram</button>
  <div id="previewContainerSigninout"></div>
  <div id="statusSigninout"></div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const botToken = "YOUR_TELEGRAM_BOT_TOKEN";
const chatId = "YOUR_CHAT_ID";
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏π‡∏õ timestamp ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏ß‡∏¥
function validateRecentPhotos(files) {
  const now = Date.now();
  for (let file of files) {
    if (now - file.lastModified > 10000) { // 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà ‡∏ì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà");
      return false;
    }
  }
  return true;
}

// ------ Patrol ------
let photosPatrol = [], locationStrPatrol = "";
document.getElementById("imageInputPatrol").addEventListener("change", e => {
  const files = Array.from(e.target.files);
  if (!validateRecentPhotos(files)) {
    e.target.value = "";
    return;
  }
  photosPatrol = files;
  updatePreview("Patrol");
});
function updatePreview(which) {
  const container = document.getElementById("previewContainer"+which);
  container.innerHTML = "";
  const files = which==="Patrol"? photosPatrol : photosSigninout;
  files.forEach(f => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(f);
    container.appendChild(img);
  });
  updatePreviewText(which);
}
function updatePreviewText(which) {
  const nowStr = new Date().toLocaleString("th-TH");
  if (which==="Patrol") {
    const z = document.getElementById("zonePatrol").value || "-";
    const j = document.getElementById("jobTypePatrol").value || "-";
    const t = document.getElementById("textPatrol").value.trim();
    document.getElementById("previewTextPatrol").textContent =
      `üìÖ ${nowStr}\nüìç ${locationStrPatrol}\nüóÇ ‡πÄ‡∏Ç‡∏ï: ${z}\nüìå ‡∏á‡∏≤‡∏ô: ${j}${t ? `\nüìù ${t}` : ""}`;
  } else {
    const z = document.getElementById("zoneSigninout").value || "-";
    const j = document.querySelector("input[name='inout']:checked")?.value || "-";
    const t = document.getElementById("textSigninout").value.trim();
    document.getElementById("previewTextSigninout").textContent =
      `üìÖ ${nowStr}\nüìç ${locationStrSigninout}\nüóÇ ‡πÄ‡∏Ç‡∏ï: ${z}\nüìå ‡∏á‡∏≤‡∏ô: ${j}${t ? `\nüìù ${t}` : ""}`;
  }
}
["zonePatrol","jobTypePatrol","textPatrol"].forEach(id=>document.getElementById(id).addEventListener("input",()=>updatePreviewText("Patrol")));
["zoneSigninout","textSigninout"].forEach(id=>document.getElementById(id).addEventListener("input",()=>updatePreviewText("Signinout")));
document.querySelectorAll("input[name='inout']").forEach(r=>r.addEventListener("change",()=>updatePreviewText("Signinout")));

// ------ Signinout ------
let photosSigninout = [], locationStrSigninout = "";
document.getElementById("imageInputSigninout").addEventListener("change", e => {
  const files = Array.from(e.target.files);
  if (!validateRecentPhotos(files)) {
    e.target.value = "";
    return;
  }
  photosSigninout = files;
  updatePreview("Signinout");
});

// ------ process image ------
async function processImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img,0,0);
      canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.9);
    };
    img.src = URL.createObjectURL(file);
  });
}

// ------ get location ------
async function getLocation(which) {
  return new Promise(resolve => {
    navigator.geolocation?.getCurrentPosition(async pos => {
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=th`);
        const data = await res.json();
        if (which==="Patrol") locationStrPatrol = data.display_name;
        else locationStrSigninout = data.display_name;
      } catch {
        if (which==="Patrol") locationStrPatrol = `${lat.toFixed(6)},${lon.toFixed(6)}`;
        else locationStrSigninout = `${lat.toFixed(6)},${lon.toFixed(6)}`;
      }
      updatePreviewText(which);
      resolve();
    }, ()=>resolve());
  });
}

// ------ send Patrol ------
async function sendPatrol() {
  if (photosPatrol.length===0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û");
  await getLocation("Patrol");
  const z = document.getElementById("zonePatrol").value;
  const j = document.getElementById("jobTypePatrol").value;
  if (!z||!j) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô");
  const text = document.getElementById("textPatrol").value.trim();
  let processed = [];
  for (let i=0;i<photosPatrol.length;i++) {
    const blob = await processImage(photosPatrol[i]);
    const caption = document.getElementById("previewTextPatrol").textContent;
    const form = new FormData();
    form.append("chat_id", chatId);
    form.append("photo", blob, `patrol_${i+1}.jpg`);
    form.append("caption", caption);
    await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {method:"POST", body:form});
    processed.push([i+1, new Date().toLocaleString("th-TH"), locationStrPatrol, z, j, text]);
  }
  await sendExcel(processed, "patrol_log.xlsx");
  document.getElementById("statusPatrol").textContent="‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
}

// ------ send Signinout ------
async function sendSigninout() {
  if (photosSigninout.length===0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û");
  await getLocation("Signinout");
  const z = document.getElementById("zoneSigninout").value;
  const radio = document.querySelector("input[name='inout']:checked");
  if (!z||!radio) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï ‡πÅ‡∏•‡∏∞ Checkin ‡∏´‡∏£‡∏∑‡∏≠ Checkout");
  const j = radio.value;
  const text = document.getElementById("textSigninout").value.trim();
  let processed = [];
  for (let i=0;i<photosSigninout.length;i++) {
    const blob = await processImage(photosSigninout[i]);
    const caption = document.getElementById("previewTextSigninout").textContent;
    const form = new FormData();
    form.append("chat_id", chatId);
    form.append("photo", blob, `signinout_${i+1}.jpg`);
    form.append("caption", caption);
    await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {method:"POST", body:form});
    processed.push([i+1, new Date().toLocaleString("th-TH"), locationStrSigninout, z, j, text]);
  }
  await sendExcel(processed, "signinout_log.xlsx");
  document.getElementById("statusSigninout").textContent="‚úÖ ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
}

// ------ send excel ------
async function sendExcel(data, filename) {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([["‡∏•‡∏≥‡∏î‡∏±‡∏ö","‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤","‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà","‡πÄ‡∏Ç‡∏ï","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô","‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"],...data]);
  XLSX.utils.book_append_sheet(wb, ws, "Log");
  const wbout = XLSX.write(wb,{bookType:"xlsx",type:"array"});
  const blob = new Blob([wbout], {type:"application/octet-stream"});
  const form = new FormData();
  form.append("chat_id", chatId);
  form.append("document", blob, filename);
  await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {method:"POST",body:form});
}
</script>
</body>
</html>
