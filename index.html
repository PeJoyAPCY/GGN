<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GGN PATROL SYSTEM (‡πÅ‡∏¢‡∏Å BOX)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    max-width: 480px;
    margin: auto;
    padding: 15px;
    background: #f0f0f5;
  }
  h2 {
    text-align: center;
    margin-bottom: 15px;
  }
  .box {
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  h3 {
    margin-top: 0;
    color: #004080;
  }
  select, input[type="file"], textarea, button {
    width: 100%;
    margin-bottom: 10px;
    font-size: 16px;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  .previewContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-bottom: 10px;
  }
  .previewContainer img {
    width: 120px;
    height: 160px;
    object-fit: cover;
    border: 2px solid #444;
    border-radius: 6px;
  }
  button {
    background-color: #004080;
    color: white;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0066cc;
  }
  .previewText {
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    white-space: pre-wrap;
    font-size: 15px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<h2>üì∑ GGN PATROL SYSTEM</h2>

<div class="box" id="patrolBox">
  <h3>‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</h3>
  <select id="zonePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <select id="jobTypePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
    <option value="‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à">‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</option>
    <option value="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
  </select>
  <input type="file" id="imageInputPatrol" accept="image/jpeg,image/png" multiple />
  <textarea id="textPatrol" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextPatrol"></div>
  <button id="sendBtnPatrol">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log</button>
  <div class="previewContainer" id="previewContainerPatrol"></div>
  <div id="statusPatrol"></div>
</div>

<div class="box" id="signinoutBox">
  <h3>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å</h3>
  <select id="zoneSigninout">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <label><input type="checkbox" id="checkinSigninout"> Checkin</label>
  <label><input type="checkbox" id="checkoutSigninout" style="margin-left:15px;"> Checkout</label>
  <input type="file" id="imageInputSigninout" accept="image/jpeg,image/png" multiple />
  <textarea id="textSigninout" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextSigninout"></div>
  <button id="sendBtnSigninout">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log</button>
  <div class="previewContainer" id="previewContainerSigninout"></div>
  <div id="statusSigninout"></div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
  const botToken = "7764756651:AAF4G_IFWjNzKoTJj_lpQW3oLANKAZIVnWU";
  const chatId = "-7906742430";

// === Common ===
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

async function processImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.9);
    };
    img.src = URL.createObjectURL(file);
  });
}

async function getLocation() {
  return new Promise(resolve => {
    if (!navigator.geolocation) return resolve("-");
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=th`);
        const data = await res.json();
        resolve(data.display_name || `${lat.toFixed(6)},${lon.toFixed(6)}`);
      } catch {
        resolve(`${lat.toFixed(6)},${lon.toFixed(6)}`);
      }
    }, () => resolve("-"));
  });
}

async function sendExcel(processed, fileName, statusEl) {
  const wb = XLSX.utils.book_new();
  const data = [["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏Ç‡∏ï", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"]];
  processed.forEach(p => data.push(p));
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Log");
  const wbout = XLSX.write(wb, {bookType:"xlsx", type:"array"});
  const excelBlob = new Blob([wbout], {type:"application/octet-stream"});

  const logForm = new FormData();
  logForm.append("chat_id", chatId);
  logForm.append("document", excelBlob, fileName);
  await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {method:"POST", body: logForm});

  statusEl.textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ log ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
}

// === Patrol ===
const zonePatrol = document.getElementById("zonePatrol");
const jobTypePatrol = document.getElementById("jobTypePatrol");
const imageInputPatrol = document.getElementById("imageInputPatrol");
const textPatrol = document.getElementById("textPatrol");
const previewTextPatrol = document.getElementById("previewTextPatrol");
const previewContainerPatrol = document.getElementById("previewContainerPatrol");
const statusPatrol = document.getElementById("statusPatrol");

let photosPatrol = [];
imageInputPatrol.addEventListener("change", e => {
  photosPatrol = Array.from(e.target.files);
  previewContainerPatrol.innerHTML = "";
  photosPatrol.forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    previewContainerPatrol.appendChild(img);
  });
  updatePreviewPatrol();
});
[zonePatrol, jobTypePatrol, textPatrol].forEach(el => el.addEventListener("input", updatePreviewPatrol));
async function updatePreviewPatrol() {
  const loc = await getLocation();
  const nowStr = new Date().toLocaleString("th-TH");
  previewTextPatrol.textContent =
    `üìÖ ${nowStr}\nüìç ${loc}\nüóÇ ‡πÄ‡∏Ç‡∏ï: ${zonePatrol.value||"-"}\nüìå ‡∏á‡∏≤‡∏ô: ${jobTypePatrol.value||"-"}${textPatrol.value.trim()?`\nüìù ${textPatrol.value.trim()}`:""}`;
}
document.getElementById("sendBtnPatrol").addEventListener("click", async () => {
  if (!zonePatrol.value || !jobTypePatrol.value || photosPatrol.length===0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }
  statusPatrol.textContent = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
  const loc = await getLocation();
  const nowStr = new Date().toLocaleString("th-TH");
  let processed = [];
  for (let i=0; i<photosPatrol.length; i++) {
    const blob = await processImage(photosPatrol[i]);
    const form = new FormData();
    form.append("chat_id", chatId);
    form.append("photo", blob, `patrol_${i+1}.jpg`);
    form.append("caption", previewTextPatrol.textContent);
    await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {method:"POST", body:form});
    processed.push([i+1, nowStr, loc, zonePatrol.value, jobTypePatrol.value, textPatrol.value.trim()]);
  }
  await sendExcel(processed, "patrol_log.xlsx", statusPatrol);
});

// === Signinout ===
const zoneSigninout = document.getElementById("zoneSigninout");
const checkinSigninout = document.getElementById("checkinSigninout");
const checkoutSigninout = document.getElementById("checkoutSigninout");
const imageInputSigninout = document.getElementById("imageInputSigninout");
const textSigninout = document.getElementById("textSigninout");
const previewTextSigninout = document.getElementById("previewTextSigninout");
const previewContainerSigninout = document.getElementById("previewContainerSigninout");
const statusSigninout = document.getElementById("statusSigninout");

let photosSigninout = [];
imageInputSigninout.addEventListener("change", e => {
  photosSigninout = Array.from(e.target.files);
  previewContainerSigninout.innerHTML = "";
  photosSigninout.forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    previewContainerSigninout.appendChild(img);
  });
  updatePreviewSigninout();
});
[zoneSigninout, checkinSigninout, checkoutSigninout, textSigninout].forEach(el => el.addEventListener("input", updatePreviewSigninout));
async function updatePreviewSigninout() {
  const loc = await getLocation();
  const nowStr = new Date().toLocaleString("th-TH");
  let job = "-";
  if (checkinSigninout.checked && checkoutSigninout.checked) job="Checkin+Checkout";
  else if (checkinSigninout.checked) job="Checkin";
  else if (checkoutSigninout.checked) job="Checkout";
  previewTextSigninout.textContent =
    `üìÖ ${nowStr}\nüìç ${loc}\nüóÇ ‡πÄ‡∏Ç‡∏ï: ${zoneSigninout.value||"-"}\nüìå ‡∏á‡∏≤‡∏ô: ${job}${textSigninout.value.trim()?`\nüìù ${textSigninout.value.trim()}`:""}`;
}
document.getElementById("sendBtnSigninout").addEventListener("click", async () => {
  if (!zoneSigninout.value || (!checkinSigninout.checked && !checkoutSigninout.checked) || photosSigninout.length===0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }
  statusSigninout.textContent = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...";
  const loc = await getLocation();
  const nowStr = new Date().toLocaleString("th-TH");
  let processed = [], idx=1;
  for (let i=0; i<photosSigninout.length; i++) {
    const blob = await processImage(photosSigninout[i]);
    let jobs=[];
    if (checkinSigninout.checked) jobs.push("Checkin");
    if (checkoutSigninout.checked) jobs.push("Checkout");
    for (let job of jobs) {
      const form = new FormData();
      form.append("chat_id", chatId);
      form.append("photo", blob, `signinout_${i+1}_${job}.jpg`);
      form.append("caption", previewTextSigninout.textContent+`\nüìù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${job}`);
      await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {method:"POST", body:form});
      processed.push([idx++, nowStr, loc, zoneSigninout.value, job, textSigninout.value.trim()]);
    }
  }
  await sendExcel(processed, "signinout_log.xlsx", statusSigninout);
});
</script>
</body>
</html>
