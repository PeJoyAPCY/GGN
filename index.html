<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GGN PATROL SYSTEM - ‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏¢‡∏Å</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    max-width: 800px;
    margin: auto;
    padding: 15px;
    background: #f0f0f5;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }
  .box {
    background: white;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    max-width: 380px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  h2 {
    text-align: center;
    margin-bottom: 15px;
  }
  select, input[type="file"], textarea, button {
    width: 100%;
    margin-bottom: 10px;
    font-size: 16px;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  .previewContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-bottom: 10px;
  }
  .previewContainer img {
    width: 100px;
    height: 140px;
    object-fit: cover;
    border: 2px solid #444;
    border-radius: 6px;
  }
  button {
    background-color: #004080;
    color: white;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0066cc;
  }
  .previewText {
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    white-space: pre-wrap;
    font-size: 15px;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à -->
<div class="box">
  <h2>üìå ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</h2>
  <select id="zonePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <select id="jobTypePatrol">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
    <option value="‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à">‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</option>
    <option value="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
  </select>
  <input type="file" id="imageInputPatrol" accept="image/jpeg,image/png" multiple />
  <textarea id="textPatrol" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextPatrol"></div>
  <button id="sendBtnPatrol">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log</button>
  <div class="previewContainer" id="previewContainerPatrol"></div>
  <div id="statusPatrol"></div>
</div>

<!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å -->
<div class="box">
  <h2>üìù ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å</h2>
  <select id="zoneSigninout">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
    <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
    <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
    <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
  </select>
  <label><input type="checkbox" id="checkinSigninout"> Checkin</label>
  <label><input type="checkbox" id="checkoutSigninout"> Checkout</label>
  <input type="file" id="imageInputSigninout" accept="image/jpeg,image/png" multiple />
  <textarea id="textSigninout" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
  <div class="previewText" id="previewTextSigninout"></div>
  <button id="sendBtnSigninout">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log</button>
  <div class="previewContainer" id="previewContainerSigninout"></div>
  <div id="statusSigninout"></div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const botToken = "YOUR_BOT_TOKEN";
const chatId = "YOUR_CHAT_ID";

// -------------------- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à --------------------
const zonePatrol = document.getElementById("zonePatrol");
const jobTypePatrol = document.getElementById("jobTypePatrol");
const imageInputPatrol = document.getElementById("imageInputPatrol");
const previewContainerPatrol = document.getElementById("previewContainerPatrol");
const previewTextPatrol = document.getElementById("previewTextPatrol");
const extraTextPatrol = document.getElementById("textPatrol");
const statusPatrol = document.getElementById("statusPatrol");
let photosPatrol = [], locationStrPatrol = "";

imageInputPatrol.addEventListener("change", e => {
  photosPatrol = Array.from(e.target.files);
  updatePreview(previewContainerPatrol, photosPatrol);
});

function updatePreviewTextPatrol() {
  const nowStr = new Date().toLocaleString("th-TH");
  previewTextPatrol.textContent =
    `üìÖ ${nowStr}\nüìç ${locationStrPatrol}\nüóÇ ‡πÄ‡∏Ç‡∏ï: ${zonePatrol.value || "-"}\nüìå ‡∏á‡∏≤‡∏ô: ${jobTypePatrol.value || "-"}${extraTextPatrol.value.trim() ? "\nüìù " + extraTextPatrol.value.trim() : ""}`;
}
zonePatrol.addEventListener("change", updatePreviewTextPatrol);
jobTypePatrol.addEventListener("change", updatePreviewTextPatrol);
extraTextPatrol.addEventListener("input", updatePreviewTextPatrol);

// -------------------- ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å --------------------
const zoneSigninout = document.getElementById("zoneSigninout");
const checkinSigninout = document.getElementById("checkinSigninout");
const checkoutSigninout = document.getElementById("checkoutSigninout");
const imageInputSigninout = document.getElementById("imageInputSigninout");
const previewContainerSigninout = document.getElementById("previewContainerSigninout");
const previewTextSigninout = document.getElementById("previewTextSigninout");
const extraTextSigninout = document.getElementById("textSigninout");
const statusSigninout = document.getElementById("statusSigninout");
let photosSigninout = [], locationStrSigninout = "";

imageInputSigninout.addEventListener("change", e => {
  photosSigninout = Array.from(e.target.files);
  updatePreview(previewContainerSigninout, photosSigninout);
});

function updatePreviewTextSigninout() {
  const nowStr = new Date().toLocaleString("th-TH");
  let job = "-";
  if (checkinSigninout.checked && checkoutSigninout.checked) job = "Checkin + Checkout";
  else if (checkinSigninout.checked) job = "Checkin";
  else if (checkoutSigninout.checked) job = "Checkout";
  previewTextSigninout.textContent =
    `üìÖ ${nowStr}\nüìç ${locationStrSigninout}\nüóÇ ‡πÄ‡∏Ç‡∏ï: ${zoneSigninout.value || "-"}\nüìå ‡∏á‡∏≤‡∏ô: ${job}${extraTextSigninout.value.trim() ? "\nüìù " + extraTextSigninout.value.trim() : ""}`;
}
zoneSigninout.addEventListener("change", updatePreviewTextSigninout);
checkinSigninout.addEventListener("change", updatePreviewTextSigninout);
checkoutSigninout.addEventListener("change", updatePreviewTextSigninout);
extraTextSigninout.addEventListener("input", updatePreviewTextSigninout);

// -------------------- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢ --------------------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function updatePreview(container, files) {
  container.innerHTML = "";
  files.forEach(file => {
    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    container.appendChild(img);
  });
}

async function processImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.9);
    };
    img.src = URL.createObjectURL(file);
  });
}

// -------------------- Get Location --------------------
async function getLocation(setter) {
  if (!navigator.geolocation) return "";
  return new Promise(resolve => {
    navigator.geolocation.getCurrentPosition(async pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=th`);
        const data = await res.json();
        setter(data.display_name || `${lat.toFixed(6)},${lon.toFixed(6)}`);
      } catch {
        setter(`${lat.toFixed(6)},${lon.toFixed(6)}`);
      }
      resolve();
    }, () => resolve());
  });
}

// -------------------- ‡∏™‡πà‡∏á Patrol --------------------
document.getElementById("sendBtnPatrol").addEventListener("click", async () => {
  if (!zonePatrol.value || !jobTypePatrol.value || photosPatrol.length == 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }
  statusPatrol.textContent = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
  await getLocation(v => { locationStrPatrol = v; updatePreviewTextPatrol(); });
  let processed = [], nowStr = new Date().toLocaleString("th-TH");

  for (let i=0; i<photosPatrol.length; i++) {
    const blob = await processImage(photosPatrol[i]);
    const form = new FormData();
    form.append("chat_id", chatId);
    form.append("photo", blob, `patrol_${i+1}.jpg`);
    form.append("caption", previewTextPatrol.textContent);
    await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: "POST", body: form });
    processed.push([i+1, nowStr, locationStrPatrol, zonePatrol.value, jobTypePatrol.value, extraTextPatrol.value]);
  }

  sendExcel(processed, "patrol_log.xlsx", statusPatrol);
});

// -------------------- ‡∏™‡πà‡∏á Signinout --------------------
document.getElementById("sendBtnSigninout").addEventListener("click", async () => {
  if (!zoneSigninout.value || (!checkinSigninout.checked && !checkoutSigninout.checked) || photosSigninout.length == 0) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }
  statusSigninout.textContent = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
  await getLocation(v => { locationStrSigninout = v; updatePreviewTextSigninout(); });
  let processed = [], nowStr = new Date().toLocaleString("th-TH");

  for (let i=0; i<photosSigninout.length; i++) {
    const blob = await processImage(photosSigninout[i]);
    const jobs = [];
    if (checkinSigninout.checked) jobs.push("Checkin");
    if (checkoutSigninout.checked) jobs.push("Checkout");
    for (const job of jobs) {
      const form = new FormData();
      form.append("chat_id", chatId);
      form.append("photo", blob, `signinout_${i+1}_${job}.jpg`);
      form.append("caption", previewTextSigninout.textContent + `\nüìå ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ${job}`);
      await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, { method: "POST", body: form });
      processed.push([processed.length+1, nowStr, locationStrSigninout, zoneSigninout.value, job, extraTextSigninout.value]);
    }
  }

  sendExcel(processed, "signinout_log.xlsx", statusSigninout);
});

// -------------------- ‡∏™‡πà‡∏á Excel Log --------------------
async function sendExcel(rows, filename, statusElem) {
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏Ç‡∏ï", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"], ...rows]);
  XLSX.utils.book_append_sheet(wb, ws, "Log");
  const wbout = XLSX.write(wb, {bookType:"xlsx", type:"array"});
  const blob = new Blob([wbout], {type:"application/octet-stream"});
  const form = new FormData();
  form.append("chat_id", chatId);
  form.append("document", blob, filename);
  await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, { method:"POST", body: form });
  statusElem.textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
}
</script>

</body>
</html>
