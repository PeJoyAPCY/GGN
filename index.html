<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>GGN Check-in</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û + ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Telegram ‡πÅ‡∏•‡∏∞ Google Sheets</h2>
  <form id="myForm">
    <input type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required><br><br>
    <input type="text" name="location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" required><br><br>
    <input type="text" name="job" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" required><br><br>
    <input type="text" name="extraMsg" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"><br><br>
    <input type="file" name="photos" accept="image/*" multiple required><br><br>
    <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </form>

  <script>
    const botToken = "7764756651:AAF4G_IFWjNzKoTJj_lpQW3oLANKAZIVnWU";
    const chatId = "-4929290865";
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxGXG8cZz4_mbuGqxzX2T4Kqo8ZteUiUtO5jEMYhvaqeKuxlzD_QkcPVA1hCcmA6NA/exec";

    document.getElementById("myForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const form = e.target;
      const name = form.name.value;
      const location = form.location.value;
      const job = form.job.value;
      const extraMsg = form.extraMsg.value;
      const photos = form.photos.files;

      const nowStr = new Date().toLocaleString("th-TH");
      const caption = `üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${location}\nüë§ ‡∏ä‡∏∑‡πà‡∏≠: ${name}\nüíº ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${job}\nüïí ‡πÄ‡∏ß‡∏•‡∏≤: ${nowStr}\nüìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${extraMsg}`;
      const processedPhotos = [];

      for (let i = 0; i < photos.length; i++) {
        const blob = await processImage(photos[i]);
        const formData = new FormData();
        formData.append("chat_id", chatId);
        formData.append("photo", blob, `photo${i + 1}.jpg`);
        formData.append("caption", caption);

        await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
          method: "POST",
          body: formData
        });

        processedPhotos.push({
          ‡∏•‡∏≥‡∏î‡∏±‡∏ö: i + 1,
          ‡πÄ‡∏ß‡∏•‡∏≤: nowStr,
          ‡∏ä‡∏∑‡πà‡∏≠: name,
          ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: job,
          ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: extraMsg,
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: location
        });

        // ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheet
        await sendToGoogleSheet({
          time: nowStr,
          name,
          location,
          job,
          extraMsg
        });
      }

      sendExcelToTelegram(processedPhotos);
    });

    async function sendExcelToTelegram(dataArray) {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(dataArray);
      XLSX.utils.book_append_sheet(wb, ws, "Log");
      const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
      const file = new Blob([wbout], { type: "application/octet-stream" });

      const formData = new FormData();
      formData.append("chat_id", chatId);
      formData.append("document", file, "log.xlsx");

      await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {
        method: "POST",
        body: formData
      });
    }

    function processImage(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement("canvas");
            const maxSize = 1280;
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) {
                height *= maxSize / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width *= maxSize / height;
                height = maxSize;
              }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => resolve(blob), "image/jpeg", 0.85);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function sendToGoogleSheet(data) {
      try {
        const res = await fetch(webAppUrl, {
          method: "POST",
          body: JSON.stringify({ contents: data }),
          headers: {
            "Content-Type": "application/json"
          }
        });
        const result = await res.text();
        console.log("‚úÖ Google Sheet:", result);
      } catch (err) {
        console.error("‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏õ Google Sheet ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
      }
    }
  </script>
</body>
</html>
