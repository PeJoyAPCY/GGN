<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GGN PATROL SYSTEM</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    max-width: 480px;
    margin: auto;
    padding: 15px;
    background: #f0f0f5;
  }
  h2 {
    text-align: center;
  }
  select, input[type="file"], textarea, button {
    width: 100%;
    margin-bottom: 10px;
    font-size: 16px;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  #previewContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
  }
  #previewContainer img {
    width: 120px;
    height: 160px;
    object-fit: cover;
    border: 2px solid #444;
    border-radius: 6px;
  }
  button {
    background-color: #004080;
    color: white;
    font-size: 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0066cc;
  }
  #previewText {
    background: #fff;
    border: 1px solid #ccc;
    padding: 10px;
    white-space: pre-wrap;
    font-size: 15px;
  }
  canvas {
    display: none;
  }
  .inline-label {
    display: inline-block;
    margin-right: 10px;
  }
</style>
</head>
<body>

<h2>üì∑ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û + ‡∏™‡πà‡∏á Log ‡πÄ‡∏Ç‡πâ‡∏≤ Telegram</h2>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï -->
<select id="zone">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
  <option value="‡πÇ‡∏ã‡∏ô A">‡πÇ‡∏ã‡∏ô A</option>
  <option value="‡πÇ‡∏ã‡∏ô B">‡πÇ‡∏ã‡∏ô B</option>
  <option value="‡πÇ‡∏ã‡∏ô C">‡πÇ‡∏ã‡∏ô C</option>
</select>

<!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏•‡∏±‡∏Å -->
<select id="mainType">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å --</option>
  <option value="‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î">‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î</option>
  <option value="checkinout">Checkin / Checkout</option>
</select>

<!-- ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î -->
<div id="checkJobContainer" style="display:none;">
  <select id="jobType">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
    <option value="‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à">‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</option>
    <option value="‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
  </select>
</div>

<!-- ‡πÇ‡∏´‡∏°‡∏î Checkin / Checkout -->
<div id="checkinoutContainer" style="display:none;">
  <label class="inline-label"><input type="checkbox" id="checkin"> Checkin</label>
  <label class="inline-label"><input type="checkbox" id="checkout"> Checkout</label>
</div>

<input type="file" id="imageInput" accept="image/jpeg,image/png" multiple />
<textarea id="text" rows="2" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
<div id="previewText"></div>
<button id="sendBtn">‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ Log ‡πÄ‡∏Ç‡πâ‡∏≤ Telegram</button>

<div id="previewContainer"></div>
<div id="status"></div>
<canvas id="canvas"></canvas>

<script>
  const botToken = "7764756651:AAF4G_IFWjNzKoTJj_lpQW3oLANKAZIVnWU";
  const chatId = "7906742430";

  const zone = document.getElementById("zone");
  const mainType = document.getElementById("mainType");
  const checkJobContainer = document.getElementById("checkJobContainer");
  const jobType = document.getElementById("jobType");
  const checkinoutContainer = document.getElementById("checkinoutContainer");
  const checkin = document.getElementById("checkin");
  const checkout = document.getElementById("checkout");
  const imageInput = document.getElementById("imageInput");
  const previewContainer = document.getElementById("previewContainer");
  const previewText = document.getElementById("previewText");
  const extraText = document.getElementById("text");
  const status = document.getElementById("status");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  let photos = [];
  let processedPhotos = [];
  let locationStr = "";

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏° mainType
  mainType.addEventListener("change", () => {
    if (mainType.value === "checkinout") {
      checkJobContainer.style.display = "none";
      checkinoutContainer.style.display = "block";
    } else if (mainType.value === "‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î") {
      checkJobContainer.style.display = "block";
      checkinoutContainer.style.display = "none";
    } else {
      checkJobContainer.style.display = "none";
      checkinoutContainer.style.display = "none";
    }
    updatePreviewText();
  });

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ preview ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
  imageInput.addEventListener("change", (e) => {
    photos = Array.from(e.target.files).filter(file => {
      if (file.type === "image/heic" || file.name.endsWith(".heic")) {
        alert("‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .heic ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ .jpg ‡∏´‡∏£‡∏∑‡∏≠ .png");
        return false;
      }
      return true;
    });
    updatePreview();
  });

  function updatePreview() {
    previewContainer.innerHTML = "";
    photos.forEach(file => {
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      previewContainer.appendChild(img);
    });
  }

  // ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
  function getLocation() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) return resolve("");
      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=th`);
          const data = await res.json();
          locationStr = data.display_name || `${lat.toFixed(6)},${lon.toFixed(6)}`;
        } catch {
          locationStr = `${lat.toFixed(6)},${lon.toFixed(6)}`;
        }
        updatePreviewText();
        resolve();
      }, () => resolve());
    });
  }

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° preview
  function updatePreviewText() {
    const selectedZone = zone.value || "-";
    const selectedMain = mainType.value || "-";
    const selectedJob = (selectedMain === "‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î") ? (jobType.value || "-") : "-";
    const extra = extraText.value.trim();
    const nowStr = new Date().toLocaleString("th-TH");

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î jobType preview ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö checkinout
    let jobPreview = "-";
    if (selectedMain === "checkinout") {
      const c = checkin.checked;
      const o = checkout.checked;
      if (c && o) jobPreview = "Checkin + Checkout";
      else if (c) jobPreview = "Checkin";
      else if (o) jobPreview = "Checkout";
      else jobPreview = "-";
    } else if (selectedMain === "‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î") {
      jobPreview = selectedJob;
    }

    previewText.textContent = 
      `üìÖ ${nowStr}\nüìç ${locationStr}\nüóÇ ‡πÄ‡∏Ç‡∏ï: ${selectedZone}\nüìå ‡∏á‡∏≤‡∏ô: ${jobPreview}${extra ? `\nüìù ${extra}` : ""}`;
  }

  extraText.addEventListener("input", updatePreviewText);
  jobType.addEventListener("change", updatePreviewText);
  zone.addEventListener("change", updatePreviewText);
  checkin.addEventListener("change", updatePreviewText);
  checkout.addEventListener("change", updatePreviewText);

  // process ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô jpeg blob
  async function processImage(file) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.9);
      };
      img.src = URL.createObjectURL(file);
    });
  }

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Telegram
  async function sendToTelegram() {
    if (photos.length === 0) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
      return;
    }
    if (!mainType.value) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å");
      return;
    }
    if (mainType.value === "‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î" && !jobType.value) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô");
      return;
    }
    if (mainType.value === "checkinout" && !checkin.checked && !checkout.checked) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Checkin ‡∏´‡∏£‡∏∑‡∏≠ Checkout ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
      return;
    }

    status.textContent = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
    await getLocation();

    const nowStr = new Date().toLocaleString("th-TH");
    const selectedZone = zone.value || "-";
    const extraMsg = extraText.value.trim();

    processedPhotos = [];

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° log ‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô
    let idx = 1;
    for (let i = 0; i < photos.length; i++) {
      const blob = await processImage(photos[i]);

      // ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏° caption ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å checkin+checkout ‡∏™‡πà‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô)
      let caption = "";
      if (mainType.value === "‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î") {
        caption = previewText.textContent;
      } else if (mainType.value === "checkinout") {
        const jobs = [];
        if (checkin.checked) jobs.push("Checkin");
        if (checkout.checked) jobs.push("Checkout");
        caption = previewText.textContent + "\nüìù (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: " + jobs.join(" + ") + ")";
      }

      // ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏π‡∏õ
      const form = new FormData();
      form.append("chat_id", chatId);
      form.append("photo", blob, `photo${i + 1}.jpg`);
      form.append("caption", caption);
      await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
        method: "POST",
        body: form
      });

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• log
      if (mainType.value === "‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏∏‡∏î") {
        processedPhotos.push({
          i: idx++,
          nowStr,
          location: locationStr,
          zone: selectedZone,
          job: jobType.value,
          extraMsg
        });
      } else if (mainType.value === "checkinout") {
        if (checkin.checked) {
          processedPhotos.push({
            i: idx++,
            nowStr,
            location: locationStr,
            zone: selectedZone,
            job: "Checkin",
            extraMsg
          });
        }
        if (checkout.checked) {
          processedPhotos.push({
            i: idx++,
            nowStr,
            location: locationStr,
            zone: selectedZone,
            job: "Checkout",
            extraMsg
          });
        }
      }
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel
    const wb = XLSX.utils.book_new();
    const data = [["‡∏•‡∏≥‡∏î‡∏±‡∏ö", "‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà", "‡πÄ‡∏Ç‡∏ï", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"]];
    processedPhotos.forEach(p => {
      data.push([p.i, p.nowStr, p.location, p.zone, p.job, p.extraMsg]);
    });
    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, "Log");
    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    const excelBlob = new Blob([wbout], { type: "application/octet-stream" });

    // ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÄ‡∏Ç‡πâ‡∏≤ Telegram
    const logForm = new FormData();
    logForm.append("chat_id", chatId);
    logForm.append("document", excelBlob, "log.xlsx");
    await fetch(`https://api.telegram.org/bot${botToken}/sendDocument`, {
      method: "POST",
      body: logForm
    });

    status.textContent = "‚úÖ ‡∏™‡πà‡∏á‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞ log ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
    photos = [];
    updatePreview();
    previewText.textContent = "";
    extraText.value = "";
    checkin.checked = false;
    checkout.checked = false;
    mainType.value = "";
    checkJobContainer.style.display = "none";
    checkinoutContainer.style.display = "none";
    jobType.value = "";
  }

  // ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  document.getElementById("sendBtn").addEventListener("click", sendToTelegram);

  // ‡∏ú‡∏π‡∏Å event ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï preview text
  extraText.addEventListener("input", updatePreviewText);
  jobType.addEventListener("change", updatePreviewText);
  zone.addEventListener("change", updatePreviewText);
  checkin.addEventListener("change", updatePreviewText);
  checkout.addEventListener("change", updatePreviewText);

</script>

</body>
</html>
